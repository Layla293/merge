<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>Tool Gộp Truyện</title>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    input, button { margin: 10px 0; padding: 8px; }
    .log { white-space: pre-wrap; font-size: 14px; color: #444; margin-top: 10px; }
  </style>
</head>
<body>
  <h1>Tool Gộp ZIP Truyện (chuẩn Layla)</h1>
  <input type="file" id="zipInput" multiple><br>
  <button onclick="process()">Gộp và Tải về</button>
  <div class="log" id="log"></div>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
  <script>
    const log = document.getElementById('log');
    function logMsg(msg) { log.textContent += msg + '\n'; }

    async function process() {
      const input = document.getElementById('zipInput');
      if (!input.files.length) return alert('Chưa chọn file nào!');
      log.textContent = 'Đang xử lý...\n';

      const outZip = new JSZip();
      for (const zipFile of input.files) {
        try {
          logMsg('Đang xử lý: ' + zipFile.name);
          const zipData = await JSZip.loadAsync(zipFile);
          const folderName = zipFile.name.replace(/\.zip$/i, '').replace(/[^a-zA-Z0-9-_]/g, '_');
          const folder = outZip.folder(folderName);
          const parts = [];

          for (const path in zipData.files) {
            const entry = zipData.files[path];
            if (!entry.dir) {
              const content = await entry.async('uint8array');
              const name = path.split('/').pop();
              folder.file(name, content);
              if (name.match(/^part.*\.txt$/i)) parts.push(name);
            }
          }

          folder.file("info.json", JSON.stringify({
            title: folderName,
            tags: [],
            status: "unknown",
            source: "LaylaMerge"
          }, null, 2));

          const indexHtml = `<!DOCTYPE html><html><head><meta charset="UTF-8"><title>${folderName}</title>
<style>body{font-family:sans-serif;padding:20px}a{display:block;margin:4px 0}</style>
</head><body><h1>${folderName}</h1><ul>${
            parts.map(p => `<li><a href="${p}" target="_blank">${p}</a></li>`).join('')
          }</ul></body></html>`;

          folder.file("index.html", indexHtml);
          logMsg('✔ Xong: ' + folderName);
        } catch (err) {
          logMsg('❌ Lỗi khi xử lý ' + zipFile.name + ': ' + err.message);
        }
      }

      const blob = await outZip.generateAsync({type: 'blob'});
      saveAs(blob, 'LaylaTruyen_Merged.zip');
      logMsg('\nHoàn tất!');
    }
  </script>
</body>
</html>
